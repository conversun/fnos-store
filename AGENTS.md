# fnos-store — fnOS App Store

**Generated:** 2026-02-13
**Commit:** 453a40b
**Branch:** main

## OVERVIEW

Web-based app store for fnOS NAS. Go 1.25 backend (stdlib HTTP, zero dependencies) serves a React 19 SPA. Downloads `.fpk` packages from GitHub releases, installs via `appcenter-cli`.

## STRUCTURE

```
fnos-store/
├── cmd/server/main.go       # Entry point: bootstraps all deps, serves on :8011
├── internal/
│   ├── api/                 # HTTP handlers, SSE streaming, operation queue (see api/AGENTS.md)
│   ├── core/                # Business logic: Registry (merge local+remote), Downloader, Manifest parser, version comparison
│   ├── platform/            # AppCenter interface + Linux real / macOS mock implementations
│   ├── source/              # Source interface + FNOSAppsSource (fetches apps.json from GitHub)
│   ├── cache/               # File-based cache store with stale cleanup (>7 days)
│   ├── config/              # JSON config manager (check_interval, mirror) with RWMutex
│   └── scheduler/           # Cron-like ticker for periodic registry refresh
├── frontend/                # React 19 + TypeScript + Tailwind 4 + shadcn/ui
│   └── src/
│       ├── App.tsx          # Root: sidebar nav, SSE listener, install/update/uninstall orchestration
│       ├── components/      # AppCard, AppList, ProgressOverlay, SettingsDialog
│       ├── components/ui/   # 13 shadcn/ui primitives (DO NOT edit manually — regenerate via CLI)
│       └── api/client.ts    # Typed fetch wrappers + EventSource for SSE
├── fnos/                    # fpk manifest, icons, wizard config, startup scripts
├── web/                     # Embedded frontend build output (git-ignored, generated by Vite)
├── dev/                     # Mock data: mock-appcenter-cli.sh, mock-apps/, qa/
├── web_embed.go             # `//go:embed web/*` — embeds frontend into Go binary
├── build.sh                 # Full build: npm build → Go cross-compile → fnpack fpk
└── Makefile                 # dev, build-linux-{x86,arm}, build-frontend, fpk, clean
```

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| Add API endpoint | `internal/api/router.go` | Add to `routes()`, create handler in new/existing file |
| Response types | `internal/api/responses.go` | All JSON response structs defined here |
| JSON helpers | `internal/api/helpers.go` | `writeJSON()`, `writeAPIError()`, `formatTimestamp()` |
| SSE streaming | `internal/api/sse.go` | `sseStream` with `sendProgress()` / `sendError()` |
| Install/update pipeline | `internal/api/pipeline.go` | download → install-fpk → verify → refresh |
| Operation serialization | `internal/api/queue.go` | `OperationQueue` prevents concurrent CLI operations |
| App metadata merging | `internal/core/registry.go` | `Merge()` joins local manifests + remote catalog |
| Version comparison | `internal/core/version.go` | Semantic version comparison + revision suffix handling |
| Download with mirrors | `internal/core/downloader.go` | Mirror fallback, progress callbacks, temp file cleanup |
| Platform abstraction | `internal/platform/appcenter.go` | Interface: List, Check, InstallFpk, Uninstall, Start, Stop |
| Mock for macOS dev | `internal/platform/appcenter_mock.go` | Simulates appcenter-cli for local development |
| Remote app catalog | `internal/source/fnos_apps.go` | Fetches apps.json, applies mirror prefix, cache fallback |
| Frontend API client | `frontend/src/api/client.ts` | All fetch wrappers + TypeScript interfaces |
| Frontend entry | `frontend/src/App.tsx` | SSE connection, filter state, install/update/uninstall handlers |

## CODE MAP

| Symbol | Type | Location | Role |
|--------|------|----------|------|
| `Server` | struct | `api/router.go` | Central coordinator: holds all deps, serves HTTP |
| `Config` | struct | `api/router.go` | Dependency injection container for Server |
| `AppCenter` | interface | `platform/appcenter.go` | Platform abstraction (List/Check/Install/Uninstall/Start/Stop) |
| `Source` | interface | `source/source.go` | Remote catalog abstraction (Name/FetchApps) |
| `Registry` | struct | `core/registry.go` | Merges local+remote into unified app list |
| `Downloader` | struct | `core/downloader.go` | HTTP download with mirror fallback + progress |
| `Manager` | struct | `config/config.go` | Thread-safe config persistence (JSON file) |
| `Scheduler` | struct | `scheduler/cron.go` | Periodic registry refresh ticker |
| `OperationQueue` | struct | `api/queue.go` | Serializes CLI operations (one at a time) |
| `installPipeline` | struct | `api/pipeline.go` | Orchestrates download→install→verify flow |

## CONVENTIONS

- **Zero external Go dependencies** — stdlib only. No routers, no ORMs, no logging frameworks.
- **Go 1.22+ ServeMux patterns** — `"GET /api/apps"`, `"POST /api/apps/{appname}/install"`.
- **Thread safety** — RWMutex on Server (registry/status), Mutex on OperationQueue, RWMutex on ConfigManager.
- **SSE for long operations** — install/update/uninstall stream progress via Server-Sent Events, not polling.
- **No auth** — local service on NAS, assumes trusted network.
- **Environment fallback chain** — env var → production path → dev path (see `main.go` `envOr()`).
- **Frontend path alias** — `@/*` maps to `./src/*` (tsconfig paths).
- **shadcn/ui components** — `components/ui/` are generated; customize via props, not by editing source.

## ANTI-PATTERNS

- **DO NOT add `go.mod` dependencies** — keep stdlib-only.
- **DO NOT edit `components/ui/*.tsx`** — these are shadcn/ui generated. Override via props or wrapper components.
- **DO NOT bypass `OperationQueue`** — all appcenter-cli calls must go through `queue.WithCLI()`.
- **DO NOT poll for progress** — use SSE (`/api/events` endpoint). Frontend uses `EventSource`.
- **DO NOT write to `web/` directly** — it's generated by `npm run build` and embedded at compile time.

## COMMANDS

```bash
# Development (two terminals)
make dev                              # Go backend on :8011
cd frontend && npm install && npm run dev  # React frontend on :5173 (proxies to :8011)

# Build
make build-all                        # Frontend + Go x86 + Go arm
./build.sh                            # Full fpk build (requires fnpack)
make clean                            # Remove build artifacts

# Frontend only
cd frontend && npm run build          # Production build → ../web/
cd frontend && npm run lint           # ESLint check
```

## NOTES

- **Self-update kills the process** — `runSelfUpdate()` in pipeline.go: fnOS restarts the service after install-fpk. Frontend polls `/api/status` to detect restart.
- **Mirror priority** — tries mirror URL first, falls back to direct GitHub URL on failure.
- **Config defaults** — check every 6 hours, mirror = ghfast. Stored in `{DATA_DIR}/config.json`.
- **Dev mode auto-detection** — if `/var/apps` doesn't exist, uses `dev/mock-apps/` and `var/` locally.
- **Vite proxy** — in dev mode, frontend proxies `/api/*` to `localhost:8011` (check `vite.config.ts`).
